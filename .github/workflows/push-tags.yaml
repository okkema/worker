name: push-tags
on:
  push:
    tags: [v*]
jobs:
  release:
    name: Create release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Get commit message
        run: |
          BODY=$(git log -1 --pretty=format:%B)
          echo "$BODY"
          echo "body=$BODY" >> "$GITHUB_OUTPUT"
        id: commit-message
      - name: Check if prerelease
        run: |
          TAG=$(git describe --abbrev=0 --tags)
          echo "$TAG"
          [[ "$TAG" == *-* ]] && PRERELEASE="true" || PRERELEASE="false"
          echo "$PRERELEASE"
          echo "prerelease=$PRERELEASE" >> "$GITHUB_OUTPUT"
        id: version
      - name: Create release draft
        run: gh release create $TAG --title $TITLE --draft --generate-notes $PRERELEASE
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.ref_name }}
          TITLE: ${{ github.ref_name }}
          PRERELEASE: ${{ steps.version.outputs.prerelease == 'true' && '--prerelease' || '' }}
      - name: Publish release
        run: gh release edit $TAG --draft false 
        if: ${{ steps.version.outputs.prerelease == 'false' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.ref_name }}
